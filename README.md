목적

이 규칙은 오류를 최소화 하고 완성도 높은 코드를 작성하여 제품 품질을 높이기 위한 규칙입니다.

핵심 규칙 (필수)
	1.	Task를 계획적으로 나누고, 워크플로우를 설계하여 단계별로 진행할 것.
	2.	반드시 테스트 코드로 작성 후 단계별로 테스트 검증 후 다음 단계로 넘어갈 것.
	3.	오류 발생 시 깊게 생각하여 근본적인 문제의 원인부터 파악할 것.
	4.	원인이 파악 후 개선 사항 적용할 것.
	5.	기능 추가 등의 상황 시 코드 충돌을 방지하기 위해 불가피한 경우가 아니라면 하드 코딩은 지양할 것.

작업 방식
	•	작업 단위: 0.5~2일 크기로 쪼개기(분할 못하면 스펙 불명확 신호)
	•	브랜치 전략: trunk-based(권장) 또는 간소화 Gitflow; PR은 작게/자주
	•	커밋 규칙: Conventional Commits(feat:, fix:, chore:…)
	•	기능 플래그: 신규 기능은 기본 off, 단계적 롤아웃

테스트 원칙
	•	TDD 지향: 실패하는 테스트 → 최소 구현 → 리팩터
	•	계층: Unit(빠르게) > Integration(API/DB) > E2E(핵심 시나리오)
	•	임계치: 핵심 모듈 라인 커버리지 ≥ 80%(참고치), 스냅샷 테스트 오남용 금지
	•	비동기/네트워크: 타임아웃/재시도/에러경로 테스트 필수

코드 품질
	•	하드코딩 자제: 상수/엔드포인트/키는 .env/설정 모듈/피처플래그로
	•	에러 처리: 사용자 메시지/로그 메시지 분리, 예외 매핑 일관성
	•	리팩터링: 중복 제거, 순환 의존 금지, 모듈 경계 명확화
	•	리뷰 규칙: PR 템플릿(동기/변경점/리스크/테스트 증거) 채우기, 1+ 승인

보안/신뢰성
	•	입력 검증: URL 정규화, 프로토콜 화이트리스트, 내부 IP 차단(SSRF)
	•	비밀 관리: 키/토큰은 비밀 저장소, 로그에 출력 금지
	•	레이트리밋/백오프: 외부 캡쳐/AI 호출 보호
	•	관측성: 구조화 로그, 트레이싱(request-id), 주요 메트릭 계측

성능/비용
	•	SLO 준수: 캡쳐/AI 처리 지연 모니터링, SLA 초과 시 경보
	•	캐시/큐: 동일 URL 재요청 캐시, 백그라운드 워커로 후처리
	•	비용 가시화: AI 호출당 단가/월간 예산 대시보드

정의된 완료(DoD)
	•	요구사항 반영 및 수용 기준 충족
	•	테스트(유닛/통합/E2E) 녹색, 커버리지 리포트 첨부
	•	코드 리뷰 승인 및 린트/타입체크 통과
	•	관측(로그/메트릭) 추가, 문서/체인지로그 갱신
	•	롤백 계획 및 기능 플래그 확인

## 프로젝트 개요
- 외부 URL을 지정한 디바이스 해상도로 캡쳐하고, Nano Banana 이미지 합성 API를 통해 텍스트/이미지 기반 홈페이지 목업을 생성하는 풀스택 서비스입니다.
- 프론트엔드는 React + Vite 기반의 단일 페이지 애플리케이션이며, 백엔드는 Express + TypeScript로 구성되었습니다.
- UI는 심플한 카드형 패널 구조와 명확한 어포던스를 제공하며, 디바이스·테마·조명·인테리어·종횡비·변형 수량을 직관적으로 제어할 수 있습니다.

## 모놀리포 구성
```
Codex/
├─ backend/        # Express + Puppeteer API 서버
├─ frontend/       # Vite 기반 React UI
├─ shared storage  # 캡쳐/목업 이미지가 저장되는 storage 디렉터리(런타임 생성)
└─ package.json    # 루트 워크스페이스 스크립트
```

## 환경 변수
### backend/.env
- `PORT`: API 서버 포트 (기본값 4000)
- `ALLOWED_ORIGINS`: CORS 허용 오리진 목록(쉼표 구분)
- `NANO_BANANA_API_KEY`: Nano Banana API 인증 토큰
- `NANO_BANANA_API_URL`: Nano Banana API 엔드포인트 기본 URL (예: `https://api.nanobanana.ai/v1/mockup`)
- `STORAGE_DIR`: 이미지 저장 위치(미지정 시 `<repo>/storage`)

### frontend/.env
- `VITE_API_BASE_URL`: 백엔드 API 베이스 URL (기본값 `http://localhost:4000/api`)

`.env.example` 파일을 참고해 각 디렉터리에 `.env`를 생성 후 값을 채워주세요.

## 실행 방법
```bash
npm install              # 루트에서 워크스페이스 의존성 설치
npm run dev              # backend(4000) + frontend(5173) 동시 기동
```
- 백엔드 단독 실행: `npm run dev --workspace backend`
- 프론트엔드 단독 실행: `npm run dev --workspace frontend`

## 테스트
```bash
npm run test             # backend vitest + frontend vitest 순차 실행
```

## 주요 기능
- **링크 캡쳐**: Puppeteer로 지정 URL을 SSRF 차단 규칙에 따라 검증 후 선택 디바이스 해상도로 캡쳐합니다.
- **테마 편집**: 앵글/분위기/조명/인테리어 옵션과 종횡비, 변형 개수를 조합해 다양한 분위기의 목업을 생성합니다.
- **텍스트→이미지**: Nano Banana Text-to-Image 엔드포인트를 호출해 테마 기반 목업을 생성합니다.
- **이미지→이미지**: 캡쳐 이미지를 바탕으로 스타일 변환 목업을 생성합니다.
- **결과 관리**: 생성된 이미지는 `/media` 정적 라우트를 통해 다운로드할 수 있으며, 프론트엔드에서 바로 미리보기와 저장이 가능합니다.

## Nano Banana API 연동 참고
- 백엔드 `NanoBananaClient`는 `/text-to-image`, `/image-to-image` 엔드포인트를 대상으로 합니다.
- API 키가 없을 경우 502 에러를 반환하므로 실제 연동 전에 환경 변수를 반드시 설정하세요.
- 전달되는 payload에는 테마 메타데이터가 포함되어 있어, 추후 대시보드/모니터링 연동 시 쉽게 추적할 수 있습니다.
